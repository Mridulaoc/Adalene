<!DOCTYPE html>
<html lang="en">
<%- include ("../layout/header.ejs") %>
<body>
  <%- include ("../layout/navBarnew.ejs") %>

 <div class="container_fluid py-5">
    <div class="container">
        <h2>Your Cart</h2>
        <div class="d-flex flex-column align-items-center mb-5">
            <% if(cart.products.length >0){%>
            <table class="table table-bordered" >
                <tr>
                    <th scope="col" class="text-center">Product</th>
                    <th scope="col" class="text-center">Price</th>
                    <th scope="col" class="text-center">Quantity</th>
                    <th scope="col" class="text-center">Total</th> 
                    <th scope="col" class="text-center">Actions</th>                          
                </tr>  
                <% cart.products.forEach(item =>{%>                 
                    <tr class="">
                        
                                           
                        <td scope="row" class="text-capitalize text-center">
                        <div class="d-flex align-items-center">
                        <img src="\uploads\<%= item.product.prod_images[0] %>" alt="" height="100px" wight="100px">
                        <div class="d-flex flex-column ">
                        <p class="fs-5"><%= item.product.prod_name %></p>
                        <p class="fs-6">Color:<%= item.product.prod_color.color_name %></p>
                        </div>
                        </div>
                        </td>
                        <td class="vertical-align"><%= item.product.prod_price %></td>
                        
                        <td>
                            <div class="d-flex align-items-center my-3">
                                <button class="px-3 py-1 fw-bold border border-1 " style="background-color: #BC4C2A; color: white;border:none;" onclick="updateQuantity('<%= item.product._id %>','decrement')">-</button>
                                <input type="number" id="quantityInput-<%= item.product._id %>" value="<%= item.quantity %>" min="1" max="<%= item.product.prod_quantity %>" class="py-1 border border-1 text-center" style="border-left: none; border-right: none;" readonly>
                                <button class="px-3 py-1 fw-bold border border-1" style="background-color: #BC4C2A; color: white;border:none;"  onclick="updateQuantity('<%= item.product._id %>','increment')">+</button>                               
                            </div>
                            <span id="quantity-availablity-<%=item.product._id %>" class="fs-5 my-3" style="max-width: 20%;"></span>                           
                        </td>
                       
                        <td><%= item.product.prod_price * item.quantity %></td>
                        <td class="text-center"><button class="px-3 text-decoration-none fs-5  border rounded-2 bg-transparent " style="color: #BC4C2A;" onclick="removeItem('<%= item.product._id %>')">REMOVE</button></td>                                           
                    </tr>
                    <%})%>                                        
            </table>
        </div>

            <div class="d-flex flex-column align-items-end container">
                <table class="table border " style="width: 25%;">
                    <tr>
                        <td class="fs-5">Sub Total:</td>
                        <td class="fs-5">₹<%= totalValue %></td>
                    </tr>
                    <tr>
                        <td class="fs-5">Shipping:</td>
                        <% if (totalValue > 1000) {%>
                            <td class="fs-5">₹0</td>
                        <%} else {%>
                            <td class="fs-5">₹100</td>
                        <%}%>                        
                    </tr>
                    <tr>
                        <td class="fs-5">Total:</td>
                        <% if (totalValue > 1000) {%>
                        <td class="fs-5">₹<%= totalValue + 0  %></td>
                        <%} else {%>
                        <td class="fs-5">₹<%= totalValue  + 100 %></td> 
                        <%}%> 
                                
                    </tr>
                </table>
                <button class="px-3 text-decoration-none fs-5  border rounded-2 bg-transparent " style="color: #BC4C2A;" onclick="window.location.href='/checkout'">CHECK OUT</button>
            </div>       
           
           
            <%} else {%>    
                <h3>Your cart is empty</h3>
                <%}%>            
           

    
 </div>
<script>
    
            
            function updateQuantity(productId, action) {
             let maxQuantityPerUser = 2;
             console.log(`quantityInput-${productId}`)  
            const quantityInput = document.getElementById(`quantityInput-${productId}`);
            if (!quantityInput) {
            console.error(`No input field found for product ID: ${productId}`);
            return;
        }
            let quantity = parseInt(quantityInput.value);           
            const maxQuantity = parseInt(quantityInput.max);
            console.log(maxQuantity)
            let quantityAvailablity = document.getElementById(`quantity-availablity-${productId}`);

            if(action==='increment') {
                 if (quantity > maxQuantity) {            
                    quantityAvailablity.innerText = `Only ${maxQuantity} left `
                 }else if (quantity >= maxQuantityPerUser){
                     quantityAvailablity.innerText = 'Maximum quantity per user exceeded'
                 }else{
                    quantity= quantity + 1;
                 }
            }else if(action==='decrement'){
                if(quantity > 1){
                    quantity -= 1;
                }else{
                    quantity = 1;
                }
            }

            quantityInput.value = quantity;
            console.log(quantityInput.value)

            updateCart(productId, quantity)
        }


           async function updateCart(productId, quantity){

            try {
                const response = await fetch('/cart/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        productId: productId,
                        quantity:quantity


                    })
                });

                const data = await response.json();

                if (data.success) {
                    location.reload();
                }
            } catch (error) {
                console.error('Error updating cart:', error);
            }
        }


        async function removeItem(productId) {
            try {
                console.log(`${productId}`)
                const response = await fetch('/cart/remove', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        productId: productId
                    })
                });

                const data = await response.json();

                if (data.success) {
                    location.reload();
                }
            } catch (error) {
                console.error('Error removing item from cart:', error);
            }
        }
   
</script>


</body>
</html>