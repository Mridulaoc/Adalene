<!DOCTYPE html>
<html lang="en">
<%- include ("../layout/header.ejs") %>

    <body style="height: 100vh;">
        <%- include ("../layout/navBarnew.ejs") %>
            <div class="container-fluid mb-5">
                <div class="container">
                    <h4>Account</h4>
                    <div class="d-flex gap-5 ">
                        <div class="col-3 border px-5 py-5 rounded">
                            <p><a href="/profile" class="text-decoration-none fs-4 " style="color: #888888;">Profile</a>
                            </p>
                            <p><a href="/addresses" class="text-decoration-none fs-4 "
                                    style="color: #888888;">Addresses</a></p>
                            <p><a href="/order-history" class="text-decoration-none fs-4 "
                                    style="color: #888888;">Order</a></p>
                        </div>
                        <div class="col-8 border shadow rounded px-5">
                            <h4 class="text-center" style="padding: 1.5rem 10rem;">Order History</h4>
                            <%if (orders.length> 0 ) {%>
                                <table class="table  ">
                                    <tr class="fs-6">
                                        <th scope="col" class="text-center">Order ID</th>
                                        <th scope="col" class="text-center">Date</th>
                                        <th scope="col" class="text-center">Total</th>
                                        <th scope="col" class="text-center">Status</th>
                                        <th scope="col" class="text-center">Actions</th>
                                    </tr>

                                    <% orders.forEach(order=>{%>
                                        <tr class="">
                                            <td class="py-5 "><a href="/order-details/<%= order._id %>"
                                                    class="text-decoration-none text-black fw-bold">
                                                    <%= order.orderId %>
                                                </a></td>
                                            <td class="py-5 ">
                                                <%= moment(order.orderDate).format('MMMM Do YYYY, h:mm:ss') %>
                                            </td>
                                            <td class="py-5 ">â‚¹<%= order.total.toFixed(2) %>
                                            </td>
                                            <td class="py-5 ">
                                                <%= order.status %>
                                            </td>
                                            <td class="py-5">
                                                <% if(order.status==='Pending' ){%>
                                                    <button
                                                        class="px-3 text-decoration-none fs-6 fw-bold  border rounded-2 bg-transparent "
                                                        style="color: #BC4C2A;"
                                                        onclick="cancelOrder('<%= order._id %>')">CANCEL ORDER</button>
                                                    <% } else if(order.status==='Delivered' ) {%>
                                                        <button
                                                            class="px-3 text-decoration-none fs-6 fw-bold  border rounded-2 bg-transparent "
                                                            style="color: #BC4C2A;"
                                                            onclick="returnOrder('<%= order._id %>')">RETURN
                                                            ORDER</button>
                                                        <%}%>
                                            </td>
                                        </tr>
                                        <% }) %>
                                </table>
                                <%} else {%>
                                    <h3>No orders found</h3>
                                    <% } %>
                        </div>
                    </div>

                </div>
            </div>
            <%- include ("../layout/footerUser.ejs") %>

                <script>
                    async function cancelOrder(orderId) {
                        const result = await Swal.fire({
                            title: 'Are you sure?',
                            text: 'Do you really want to cancel this item?',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Yes, cancel it!',
                            cancelButtonText: 'No, keep it'
                        });

                        if (result.isConfirmed) {
                            await fetch('/cancel-order', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ orderId })
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        Swal.fire({
                                            icon: 'success',
                                            text: 'Order canceled successfully',
                                        }).then(() => {
                                            location.reload();
                                        })

                                    } else {

                                        Swal.fire({
                                            icon: 'Failure',
                                            text: 'Failed to cancel order'
                                        })
                                    }
                                })
                        }
                    }

                    async function returnOrder(orderId) {
                        const result = await Swal.fire({
                            title: 'Are you sure?',
                            text: 'Do you really want to return the full order?',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'Yes, return it!',
                            cancelButtonText: 'No, keep it'
                        });

                        if (result.isConfirmed) {
                            try {
                                const response = await fetch('/return-order', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ orderId })
                                });

                                const data = await response.json();

                                if (data.success) {
                                    Swal.fire('Returned!', 'The full order has been returned.', 'success')
                                        .then(() => {
                                            location.reload();
                                        });
                                } else {
                                    Swal.fire('Failed!', data.message || 'Failed to return the full order.', 'error');
                                }
                            } catch (error) {
                                console.log(error);
                                Swal.fire('Error!', 'An error occurred while returning the full order.', 'error');
                            }
                        }
                    }
                </script>
    </body>

</html>